generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum SystemRole {
  ADMIN
  USER // Обычный пользователь - может создавать игры и быть игроком
}

model User {
  id        String   @id @default(uuid())
  email     String   @unique
  name      String
  password  String
  role      SystemRole     @default(USER)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
    
  // Связи
  createdGames Game[] @relation("GameCreator")
  players      Player[] // Изменено: связь с Player вместо TeamMember
  profile      UserProfile?
  roles        UserRole[]
}

model UserProfile {
  id          String   @id @default(uuid())
  avatar      String?  // URL аватара
  bio         String?  // Описание пользователя
  rating      Int      @default(0) // Рейтинг пользователя
  gamesPlayed Int      @default(0) // Количество сыгранных игр
  gamesWon    Int      @default(0) // Количество выигранных игр
  
  // Связи
  user        User     @relation(fields: [userId], references: [id])
  userId      String   @unique // Один профиль на пользователя
}

model Role {
  id          String   @id @default(uuid())
  name        String   @unique
  description String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Связи
  users       UserRole[]
  permissions RolePermission[]
}

model Permission {
  id          String   @id @default(uuid())
  name        String   @unique
  description String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Связи
  roles       RolePermission[]
}

model UserRole {
  id        String   @id @default(uuid())
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Связи
  user      User     @relation(fields: [userId], references: [id])
  userId    String
  role      Role     @relation(fields: [roleId], references: [id])
  roleId    String

  @@unique([userId, roleId])
}

model RolePermission {
  id        String   @id @default(uuid())
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Связи
  role      Role     @relation(fields: [roleId], references: [id])
  roleId    String
  permission Permission @relation(fields: [permissionId], references: [id])
  permissionId String

  @@unique([roleId, permissionId])
}

enum GameRole {
  GAME_MASTER // Ведущий
  CONTESTANT  // Изменено: Участник игры (вместо PLAYER)
}

model Game {
  id            String        @id @default(uuid())
  title         String
  isActive      Boolean       @default(false)
  createdAt     DateTime      @default(now())
  updatedAt     DateTime      @updatedAt
  
  // Связи
  creator       User          @relation("GameCreator", fields: [creatorId], references: [id])
  creatorId     String
  categories    Category[]
  questionRows  QuestionRow[]
  gameSessions  GameSession[] // Связь с сессиями (может быть несколько сессий одной игры)
}

model Player {
  id          String   @id @default(uuid())
  name        String   // Отображаемое в игре имя (может отличаться от имени пользователя)
  points      Int      @default(0)
  role        GameRole @default(CONTESTANT)
  status      String   @default("offline") // Для отслеживания состояния подключения
  socketId    String?  // Для хранения ID текущего сокет-соединения
  
  // Связи
  gameSession GameSession @relation(fields: [gameSessionId], references: [id])
  gameSessionId String
  user        User?     @relation(fields: [userId], references: [id])
  userId      String?
  
  // Вопросы, на которые ответил этот игрок
  answeredQuestions GameSessionQuestion[]
}

model GameSession {
  id            String               @id @default(uuid())
  startedAt     DateTime             @default(now())
  endedAt       DateTime?
  currentTurn   String?              // ID игрока, чей сейчас ход
  numberOfPlayers Int                @default(3) @db.SmallInt // Максимальное количество игроков (до 10)
  numberOfAiPlayers Int              @default(0) @db.SmallInt // Количество ИИ игроков (не более, чем numberOfPlayers)
  
  // Связи
  game          Game                 @relation(fields: [gameId], references: [id])
  gameId        String               // Убрано @unique, т.к. у игры может быть несколько сессий
  players       Player[]             // Игроки, участвующие в этой сессии
  
  // Состояние вопросов в этой сессии
  questions     GameSessionQuestion[]
}

model GameSessionQuestion {
  id            String      @id @default(uuid())
  name          String      // Добавленное обязательное поле
  timer         Int         @default(5) @db.SmallInt // Таймер от 0 до 120 секунд
  isRevealed    Boolean     @default(false) // Был ли вопрос открыт
  isAnswered    Boolean     @default(false) // Был ли дан ответ
  
  // Связи
  gameSession   GameSession @relation(fields: [gameSessionId], references: [id])
  gameSessionId String
  question      Question    @relation(fields: [questionId], references: [id])
  questionId    String
  
  // Кто ответил на вопрос в этой сессии
  answeredBy       Player?  @relation(fields: [answeredByPlayerId], references: [id])
  answeredByPlayerId String?
  
  @@unique([gameSessionId, questionId])
}

model Category {
  id        String    @id @default(uuid())
  name      String
  order     Int       // Позиция категории для отображения
  
  // Связи
  game      Game      @relation(fields: [gameId], references: [id])
  gameId    String
  questions Question[]
}

model QuestionRow {
  id        String    @id @default(uuid())
  value     Int       // Стоимость вопросов в этом ряду (100, 200, 300...)
  order     Int       // Порядок отображения ряда
  
  // Связи
  game      Game      @relation(fields: [gameId], references: [id])
  gameId    String
  questions Question[]
}

model Question {
  id         String    @id @default(uuid())
  question   String
  answer     String
  
  // Связи
  category     Category   @relation(fields: [categoryId], references: [id])
  categoryId   String
  
  // Связь с рядом вопросов
  questionRow  QuestionRow @relation(fields: [rowId], references: [id])
  rowId        String
  
  // Связь с сессией игры
  gameSessionQuestion GameSessionQuestion[]
  
  // Уникальное ограничение - один вопрос на пересечении категории и ряда
  @@unique([categoryId, rowId])
}